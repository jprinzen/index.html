<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fire Truck Status Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            getDoc,
            setDoc
        };
    </script>
    <!-- Chosen Palette: Slate & Amber -->
    <!-- Application Structure Plan: A dashboard layout is used to provide an immediate, high-level overview and allow for intuitive drill-downs. The structure consists of: 1) A top-level summary with critical stats (Overall Status, Deficiencies, Key Levels) for quick assessment. 2) Tab-based navigation for each major truck system, which is a more user-friendly discovery method than a long, linear scroll. 3) A dynamic content area that displays the detailed checklist for the selected system. This tiered structure (summary -> system -> detail) was chosen because it allows a user to quickly grasp the overall situation and then efficiently investigate specific areas of concern without being overwhelmed by information, directly translating the form's data collection purpose into an effective data analysis tool. 4) A new 'Edit Dashboard' button enables inline editing of all displayed data fields, removing the need for JSON interaction. 5) A 'Generate Form Link' button allows users to export the current dashboard data into a pre-filled Google Form URL, providing a mechanism for external sharing. 6) Integrated Firestore for persistent data storage, ensuring dashboard data is saved and loaded across sessions for the authenticated user. -->
    <!-- Visualization & Content Choices:
        - Report Info: Overall Truck Status -> Goal: Inform -> Viz/Method: Large summary cards & text -> Interaction: None -> Justification: Provides the most critical information at a glance. Library: HTML/Tailwind.
        - Report Info: Fuel & Water Levels -> Goal: Inform -> Viz/Method: Donut Chart -> Interaction: Hover for details -> Justification: Provides a quick, universally understood visual for fluid levels. Library: Chart.js.
        - Report Info: Checklist Sections (Exterior, Interior, etc.) -> Goal: Organize/Navigate -> Viz/Method: Tabbed button navigation -> Interaction: Click to change view -> Justification: Breaks down a long form into manageable, logical sections for focused review. Library: JS/HTML.
        - Report Info: Detailed Checklist Items -> Goal: Inform/Organize -> Viz/Method: Styled list with status badges -> Interaction: View updates based on tab selection, inline editing in edit mode -> Justification: Clearly presents detailed data, with color-coding to instantly draw attention to issues. Inline editing provides direct, intuitive data modification. Library: JS/HTML.
        - Report Info: Deficiencies -> Goal: Inform/Organize -> Viz/Method: A consolidated list view -> Interaction: Accessed via a dedicated tab -> Justification: Gathers all action items into a single, actionable list, which is the primary operational outcome of a check. Library: JS/HTML.
        - Report Info: Data Customization -> Goal: Allow User Input/Modification -> Viz/Method: Inline editable fields -> Interaction: Toggle edit mode, update values directly, save/cancel -> Justification: Offers a highly intuitive, form-like experience for data modification without requiring JSON knowledge. Library: JS/HTML.
        - Report Info: Form Submission/Export -> Goal: Persist Data/Share -> Viz/Method: Button generates pre-filled URL -> Interaction: Click to open new tab -> Justification: Provides a practical way to capture the current state of the dashboard into a structured, external form system. Library: JS/HTML.
        - Report Info: Data Persistence -> Goal: Retain Data -> Viz/Method: Background Firebase operations -> Interaction: Automatic save/load on changes/page load -> Justification: Ensures data integrity and consistent user experience across sessions. Library: Firebase/Firestore.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 250px;
            }
        }
        .nav-button.active {
            background-color: #1e293b; /* slate-800 */
            color: #ffffff;
        }
        .status-ok { background-color: #dcfce7; color: #166534; }
        .status-issue { background-color: #fef9c3; color: #854d0e; }
        .status-danger { background-color: #fee2e2; color: #991b1b; }
        .edit-input {
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            width: 100%;
        }
        .edit-select {
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            width: 100%;
            background-color: white;
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            font-size: 1.5rem;
            color: #1e293b;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="loading-overlay" class="hidden">Loading...</div>

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900">Truck Status Dashboard</h1>
                    <p id="truck-info" class="text-slate-500 mt-1">Truck ID: <span id="truck-id-display">E-12</span> | Last Check: <span id="last-check-date-display">June 26, 2025</span></p>
                    <p class="text-slate-500 mt-1 text-sm">User ID: <span id="user-id-display">N/A</span></p>
                </div>
                <div class="mt-4 md:mt-0 flex items-center space-x-4">
                    <div id="overall-status" class="text-lg font-semibold px-4 py-2 rounded-lg"></div>
                    <button id="edit-mode-btn" class="px-4 py-2 bg-slate-800 text-white rounded-lg shadow hover:bg-slate-700 transition-colors duration-200">Edit Dashboard</button>
                    <button id="save-changes-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition-colors duration-200 hidden">Save Changes</button>
                    <button id="cancel-edit-btn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg shadow hover:bg-slate-300 transition-colors duration-200 hidden">Cancel</button>
                    <button id="generate-form-link-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors duration-200">Generate Form Link</button>
                </div>
            </div>
        </header>

        <main>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md flex flex-col justify-between">
                    <h3 class="font-semibold text-slate-600">Total Deficiencies</h3>
                    <p id="deficiencies-count" class="text-4xl font-bold text-amber-500">0</p>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-semibold text-slate-600 mb-2">Fuel Level</h3>
                    <div class="chart-container h-24 max-h-24">
                        <canvas id="fuelChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-semibold text-slate-600 mb-2">Water Tank Level</h3>
                    <div class="chart-container h-24 max-h-24">
                        <canvas id="waterChart"></canvas>
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md flex flex-col justify-between">
                    <h3 class="font-semibold text-slate-600">Odometer</h3>
                    <p id="odometer-reading" class="text-4xl font-bold text-slate-800">0</p>
                </div>
            </div>
            
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                <nav id="navigation" class="flex flex-wrap border-b border-slate-200 mb-6">
                </nav>

                <div id="details-container">
                    <h2 id="section-title" class="text-xl font-bold mb-4 text-slate-800"></h2>
                    <p id="section-intro" class="text-slate-600 mb-6"></p>
                    <ul id="checklist" class="space-y-3">
                    </ul>
                </div>
            </div>

        </main>
        
        <footer class="text-center mt-12 text-slate-400 text-sm">
            <p>Report generated on <span id="generation-date"></span>.</p>
        </footer>
    </div>

    <script type="module">
        let appData = {
            general: {
                title: 'General Information',
                intro: 'This section covers the basic operational details of the truck, including identification, crew, and key meter readings logged during the check.',
                items: [
                    { label: 'Date of Check', key: 'dateOfCheck', type: 'date', value: '2025-06-26', status: 'OK' },
                    { label: 'Truck ID/Number', key: 'truckId', type: 'text', value: 'E-12', status: 'OK' },
                    { label: 'Driver/Operator Name', key: 'driverName', type: 'text', value: 'J. Doe', status: 'OK' },
                    { label: 'Officer in Charge (OIC) Name', key: 'oicName', type: 'text', value: 'S. Smith', status: 'OK' },
                    { label: 'Shift', key: 'shift', type: 'select', options: ['Day', 'Night', '24-hour', 'Other'], value: '24-hour', status: 'OK' },
                    { label: 'Odometer Reading', key: 'odometer', type: 'number', value: '84321', unit: 'miles', status: 'OK' },
                    { label: 'Engine Hour Meter Reading', key: 'engineHours', type: 'number', value: '6789', unit: 'hours', status: 'OK' },
                ]
            },
            exterior: {
                title: 'Exterior Vehicle Check',
                intro: 'A complete walk-around inspection of the vehicle\'s exterior. This includes checking the body, lighting systems, tires, and all compartment doors to ensure operational readiness and safety.',
                items: [
                    { label: 'Visual Inspection (Body, Paint)', key: 'visualInspection', type: 'select', options: ['OK', 'Minor Issues', 'Needs Attention'], value: 'Minor Issues', status: 'Issue', note: 'Small scratch on right side panel.' },
                    { label: 'All Lighting', key: 'allLighting', type: 'select', options: ['OK', 'Bulb Out/Flickering', 'Wiring Issue', 'N/A'], value: 'OK', status: 'OK' },
                    { label: 'Siren & Air Horn', key: 'sirenAirHorn', type: 'select', options: ['OK', 'Malfunctioning', 'N/A'], value: 'OK', status: 'OK' },
                    { label: 'Tires', key: 'tires', type: 'select', options: ['OK', 'Low Pressure', 'Worn Tread', 'Damage Noted'], value: 'Low Pressure', status: 'Danger', note: 'Front-left tire pressure at 85 PSI, needs inflation.' },
                    { label: 'Undercarriage (Leaks, Damage)', key: 'undercarriage', type: 'select', options: ['OK', 'Fluid Leak', 'Visible Damage', 'N/A'], value: 'OK', status: 'OK' },
                    { label: 'Mirrors & Windows', key: 'mirrorsWindows', type: 'select', options: ['OK', 'Dirty', 'Cracked/Broken'], value: 'OK', status: 'OK' },
                    { label: 'Compartment Doors', key: 'compartmentDoors', type: 'select', options: ['OK', 'Sticking/Difficult', 'Latch Broken'], value: 'OK', status: 'OK' },
                    { label: 'Fuel Level', key: 'fuelLevel', type: 'select', options: ['Full', '3/4', '1/2', '1/4', 'Less than 1/4'], value: '3/4', status: 'OK' },
                ]
            },
            interior: {
                title: 'Interior & Cab Check',
                intro: 'An evaluation of all systems and equipment located inside the cab. This covers everything from driver controls and gauges to life-saving equipment like SCBAs and medical gear.',
                items: [
                    { label: 'All Gauges & Indicators', key: 'gaugesIndicators', type: 'select', options: ['OK (Normal Readings)', 'Abnormal Reading', 'Gauge Malfunctioning'], value: 'OK (Normal Readings)', status: 'OK' },
                    { label: 'SCBA - All Positions', key: 'scba', type: 'select', options: ['All OK', 'Low Cylinder (Specify in Notes)', 'Malfunction (Specify in Notes)', 'N/A'], value: 'OK', status: 'OK' },
                    { label: 'Vehicle Radios', key: 'vehicleRadios', type: 'select', options: ['OK', 'Static/Poor Reception', 'Not Transmitting', 'N/A'], value: 'OK', status: 'OK' },
                    { label: 'Portable Radios', key: 'portableRadios', type: 'select', options: ['OK', 'Low Battery', 'Malfunctioning', 'N/A'], value: 'Low Battery', status: 'Issue', note: 'Radio #3 needs charging.' },
                    { label: 'Medical Gear', key: 'medicalGear', type: 'select', options: ['All OK', 'Missing Item (Specify)', 'Expired Item (Specify)', 'N/A'], value: 'OK', status: 'OK' },
                    { label: 'Hand Tools', key: 'handTools', type: 'select', options: ['All OK', 'Missing Item (Specify)', 'Damaged Item (Specify)'], value: 'OK', status: 'OK' },
                    { label: 'Flashlights/Lanterns', key: 'flashlightsLanterns', type: 'select', options: ['OK', 'Low Battery', 'Not Working', 'N/A'], value: 'OK', status: 'OK' },
                    { label: 'Seat Belts', key: 'seatBelts', type: 'select', options: ['OK', 'Damaged/Frayed', 'Not Retracting'], value: 'OK', status: 'OK' },
                    { label: 'HVAC System', key: 'hvacSystem', type: 'select', options: ['OK', 'Not Working', 'Minor Issues', 'N/A'], value: 'OK', status: 'OK' },
                ]
            },
            pump: {
                title: 'Pump and Hose System Check',
                intro: 'A functional check of the complete water pumping and delivery system. This ensures the truck is ready for fire suppression activities, from the water tank to the nozzles.',
                items: [
                    { label: 'Water Tank Level', key: 'waterTankLevel', type: 'select', options: ['Full', '3/4', '1/2', '1/4', 'Less than 1/4'], value: 'Full', status: 'OK' },
                    { label: 'Pump Priming System', key: 'pumpPriming', type: 'select', options: ['OK', 'Slow Prime', 'Not Priming', 'N/A'], value: 'OK', status: 'OK' },
                    { label: 'Pump Gages', key: 'pumpGauges', type: 'select', options: ['OK', 'Inaccurate', 'Not Working', 'N/A'], value: 'OK', status: 'OK' },
                    { label: 'Discharge Gates & Valves', key: 'dischargeGates', type: 'select', options: ['All OK', 'Sticking/Leaking', 'N/A'], value: 'Sticking/Leaking', status: 'Danger', note: 'Discharge #2 valve is stiff.' },
                    { label: 'Intake Connections', key: 'intakeConnections', type: 'select', options: ['All OK', 'Missing Cap/Gasket'], value: 'OK', status: 'OK' },
                    { label: 'All Pre-connected Hose Lines', key: 'preconnectedHose', type: 'select', options: ['All OK', 'Minor Wear', 'Damaged (Specify)'], value: 'OK', status: 'OK' },
                    { label: 'Supply Hose', key: 'supplyHose', type: 'select', options: ['OK', 'Minor Wear', 'Damaged (Specify)', 'N/A'], value: 'OK', status: 'OK' },
                    { label: 'Nozzles', key: 'nozzles', type: 'select', options: ['All OK', 'Missing', 'Malfunctioning (Specify)'], value: 'OK', status: 'OK' },
                ]
            },
            specialized: {
                title: 'Specialized Equipment Check',
                intro: 'Inspection of specialized tools and equipment carried by the apparatus. This may include extrication tools, power saws, and monitoring devices, depending on the truck\'s designation.',
                items: [
                    { label: 'Thermal Imager', key: 'thermalImager', type: 'select', options: ['OK', 'Low Battery', 'Malfunctioning', 'N/A'], value: 'OK', status: 'OK' },
                    { label: 'Gas Detector', key: 'gasDetector', type: 'select', options: ['OK', 'Needs Calibration', 'Malfunctioning', 'N/A'], value: 'Needs Calibration', status: 'Issue' },
                    { label: 'Hydraulic Extrication Tools', key: 'extricationTools', type: 'select', options: ['All OK', 'Leak Noted', 'Malfunctioning Tool (Specify)', 'N/A'], value: 'OK', status: 'OK' },
                    { label: 'Power Saws', key: 'powerSaws', type: 'select', options: ['OK', 'Low Fuel', 'Doesn\'t Start', 'Blade Damaged', 'N/A'], value: 'OK', status: 'OK' },
                    { label: 'Portable Generators', key: 'portableGenerators', type: 'select', options: ['OK', 'Low Fuel', 'Doesn\'t Start', 'No Power Output', 'N/A'], value: 'OK', status: 'OK' },
                    { label: 'Ground Ladders', key: 'groundLadders', type: 'select', options: ['All OK', 'Damaged', 'Sticking', 'N/A'], value: 'OK', status: 'OK' },
                ]
            },
            deficiencies: {
                title: 'Deficiencies Summary',
                intro: 'This is a consolidated list of all items that were marked with an issue or a danger during the inspection. This serves as a primary action list for maintenance and repair.',
                items: []
            }
        };

        const statusMap = {
            'OK': 'status-ok',
            'Issue': 'status-issue',
            'Danger': 'status-danger'
        };

        let myCharts = {};
        let isEditMode = false;
        let originalAppData = JSON.parse(JSON.stringify(appData)); // Store a copy for cancel

        // Firebase variables
        let db;
        let auth;
        let userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Google Form Configuration (YOU NEED TO UPDATE THESE) ---
        const FORM_ACTION_URL = 'https://docs.google.com/forms/d/e/YOUR_GOOGLE_FORM_ID/viewform'; // Replace with your Google Form's base URL (up to /viewform)
        
        // Map appData keys to your Google Form entry IDs. Find these by using "Get pre-filled link" on your Google Form.
        const fieldMappings = {
            // General Information
            'dateOfCheck': 'entry.1500000001', // Example ID
            'truckId': 'entry.1500000002',      // Example ID
            'driverName': 'entry.1500000003',   // Example ID
            'oicName': 'entry.1500000004',      // Example ID
            'shift': 'entry.1500000005',        // Example ID
            'odometer': 'entry.1500000006',     // Example ID
            'engineHours': 'entry.1500000007',  // Example ID

            // Exterior Vehicle Check
            'visualInspection': 'entry.1500000008',
            'allLighting': 'entry.1500000009',
            'sirenAirHorn': 'entry.1500000010',
            'tires': 'entry.1500000011',
            'undercarriage': 'entry.1500000012',
            'mirrorsWindows': 'entry.1500000013',
            'compartmentDoors': 'entry.1500000014',
            'fuelLevel': 'entry.1500000015',

            // Interior & Cab Check
            'gaugesIndicators': 'entry.1500000016',
            'scba': 'entry.1500000017',
            'vehicleRadios': 'entry.1500000018',
            'portableRadios': 'entry.1500000019',
            'medicalGear': 'entry.1500000020',
            'handTools': 'entry.1500000021',
            'flashlightsLanterns': 'entry.1500000022',
            'seatBelts': 'entry.1500000023',
            'hvacSystem': 'entry.1500000024',

            // Pump and Hose System Check
            'waterTankLevel': 'entry.1500000025',
            'pumpPriming': 'entry.1500000026',
            'pumpGauges': 'entry.1500000027',
            'dischargeGates': 'entry.1500000028',
            'intakeConnections': 'entry.1500000029',
            'preconnectedHose': 'entry.1500000030',
            'supplyHose': 'entry.1500000031',
            'nozzles': 'entry.1500000032',

            // Specialized Equipment Check
            'thermalImager': 'entry.1500000033',
            'gasDetector': 'entry.1500000034',
            'extricationTools': 'entry.1500000035',
            'powerSaws': 'entry.1500000036',
            'portableGenerators': 'entry.1500000037',
            'groundLadders': 'entry.1500000038',
            
            // Deficiencies (aggregated notes)
            'deficienciesSummary': 'entry.1500000039' // Example ID for a long text field for all notes
        };
        // --- End Google Form Configuration ---


        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('loading-overlay').classList.remove('hidden'); // Show loading

            // Initialize Firebase
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const firebase = window.firebase;
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.getFirestore(app);
            auth = firebase.getAuth(app);

            let isAuthReady = false; // Flag to ensure dashboard initializes only once after auth

            // Set up the authentication state listener FIRST
            firebase.onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    console.log("User authenticated:", userId);
                } else {
                    // If no user is signed in after initial attempt, use anonymous ID or default.
                    // This handles cases where custom token fails or no token is provided.
                    userId = crypto.randomUUID();
                    document.getElementById('user-id-display').textContent = `Anon (${userId.substring(0, 8)}...)`;
                    console.log("No authenticated user, using anonymous ID:", userId);
                }

                if (!isAuthReady) {
                    await loadAppData(); // Load data once userId is set
                    initializeDashboard(); // Render dashboard
                    document.getElementById('loading-overlay').classList.add('hidden'); // Hide loading
                    isAuthReady = true; // Mark as ready to prevent re-initialization
                }
            });

            // Perform the initial sign-in attempt
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    // Try signing in with the provided custom token
                    await firebase.signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Attempted signInWithCustomToken.");
                } else {
                    // If no custom token or custom token sign-in isn't desired, sign in anonymously
                    await firebase.signInAnonymously(auth);
                    console.log("Attempted signInAnonymously.");
                }
            } catch (error) {
                console.error("Initial Firebase sign-in attempt failed:", error);
                // The onAuthStateChanged listener above will handle setting userId to anonymous/random UUID
                // and initializing the dashboard even if this initial sign-in fails.
            }

            document.getElementById('edit-mode-btn').addEventListener('click', toggleEditMode);
            document.getElementById('save-changes-btn').addEventListener('click', saveChangesAndPersist);
            document.getElementById('cancel-edit-btn').addEventListener('click', cancelEdit);
            document.getElementById('generate-form-link-btn').addEventListener('click', generateFormLink);
            document.getElementById('generation-date').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        });

        async function loadAppData() {
            try {
                if (!userId) {
                    console.log("UserID not available yet, cannot load data from Firestore.");
                    return;
                }
                const docRef = firebase.doc(db, `artifacts/${appId}/users/${userId}/truckChecks`, 'mainTruckData');
                const docSnap = await firebase.getDoc(docRef);

                if (docSnap.exists()) {
                    appData = docSnap.data();
                    console.log("Data loaded from Firestore.");
                } else {
                    console.log("No data found in Firestore for this user, using default appData.");
                    // Save default data if none exists to ensure persistence starts
                    await saveAppData(); 
                }
            } catch (e) {
                console.error("Error loading document from Firestore: ", e);
            }
        }

        async function saveAppData() {
            try {
                if (!userId) {
                    console.error("UserID not available, cannot save data to Firestore.");
                    return;
                }
                const docRef = firebase.doc(db, `artifacts/${appId}/users/${userId}/truckChecks`, 'mainTruckData');
                await firebase.setDoc(docRef, appData);
                console.log("Data saved to Firestore successfully!");
            } catch (e) {
                console.error("Error saving document to Firestore: ", e);
            }
        }

        function initializeDashboard() {
            populateDeficiencies();
            renderNavigation();
            renderSummary();
            renderCharts();
            // Retain the currently active section if switching from edit mode, otherwise default
            const currentActiveSection = document.querySelector('.nav-button.active')?.dataset.section || 'exterior';
            renderSection(currentActiveSection); 
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const editBtn = document.getElementById('edit-mode-btn');
            const saveBtn = document.getElementById('save-changes-btn');
            const cancelBtn = document.getElementById('cancel-edit-btn');

            if (isEditMode) {
                originalAppData = JSON.parse(JSON.stringify(appData)); // Save current state
                editBtn.classList.add('hidden');
                saveBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
                document.getElementById('truck-id-display').innerHTML = `<input type="text" id="edit-truck-id" class="edit-input w-24 text-base" value="${appData.general.items.find(item => item.key === 'truckId').value}">`;
                document.getElementById('last-check-date-display').innerHTML = `<input type="date" id="edit-last-check-date" class="edit-input w-32 text-base" value="${appData.general.items.find(item => item.key === 'dateOfCheck').value}">`;
            } else {
                editBtn.classList.remove('hidden');
                saveBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');
                document.getElementById('truck-id-display').textContent = appData.general.items.find(item => item.key === 'truckId').value;
                document.getElementById('last-check-date-display').textContent = appData.general.items.find(item => item.key === 'dateOfCheck').value;
            }
            // Re-render current section to show editable fields or static text
            const currentActiveSection = document.querySelector('.nav-button.active')?.dataset.section || 'exterior';
            renderSection(currentActiveSection);
        }

        async function saveChangesAndPersist() {
            // Update general info from inputs
            appData.general.items.find(item => item.key === 'truckId').value = document.getElementById('edit-truck-id').value;
            appData.general.items.find(item => item.key === 'dateOfCheck').value = document.getElementById('edit-last-check-date').value;

            // Collect updated values from all sections (not just current view)
            for (const sectionKey in appData) {
                if (sectionKey !== 'deficiencies') { // deficiencies is derived, not directly editable
                    appData[sectionKey].items.forEach(item => {
                        const valueInput = document.getElementById(`edit-value-${item.key}`);
                        const statusInput = document.getElementById(`edit-status-${item.key}`);
                        const noteInput = document.getElementById(`edit-note-${item.key}`);

                        if (valueInput) item.value = valueInput.value;
                        if (statusInput) item.status = statusInput.value;
                        if (noteInput) item.note = noteInput.value;
                    });
                }
            }
            
            toggleEditMode(); // Exit edit mode, which also triggers a re-render
            initializeDashboard(); // Re-render dashboard with latest data
            await saveAppData(); // Persist changes to Firestore
        }

        function cancelEdit() {
            appData = JSON.parse(JSON.stringify(originalAppData)); // Revert to original data
            toggleEditMode(); // Exit edit mode, which also triggers a re-render
            initializeDashboard(); // Re-render dashboard with original data
        }

        function populateDeficiencies() {
            const deficiencies = [];
            for (const key in appData) {
                if (key !== 'deficiencies' && key !== 'general' && appData[key].items) {
                    appData[key].items.forEach(item => {
                        if (item.status === 'Issue' || item.status === 'Danger') {
                            deficiencies.push({ ...item, section: appData[key].title });
                        }
                    });
                }
            }
            appData.deficiencies.items = deficiencies;
        }

        function renderNavigation() {
            const navContainer = document.getElementById('navigation');
            navContainer.innerHTML = '';
            Object.keys(appData).forEach(key => {
                const button = document.createElement('button');
                button.textContent = appData[key].title;
                button.dataset.section = key;
                button.className = 'nav-button px-3 py-2 sm:px-4 sm:py-3 text-sm sm:text-base font-medium text-slate-500 hover:text-slate-800 transition-colors duration-200';
                button.onclick = () => renderSection(key);
                navContainer.appendChild(button);
            });
        }
        
        function renderSummary() {
            const deficienciesCount = appData.deficiencies.items.length;
            document.getElementById('deficiencies-count').textContent = deficienciesCount;
            
            const overallStatusEl = document.getElementById('overall-status');
            if (deficienciesCount > 0) {
                overallStatusEl.textContent = 'Deficiencies Noted';
                overallStatusEl.className = 'text-lg font-semibold px-4 py-2 rounded-lg bg-red-100 text-red-800';
            } else {
                overallStatusEl.textContent = 'Ready for Service';
                overallStatusEl.className = 'text-lg font-semibold px-4 py-2 rounded-lg bg-green-100 text-green-800';
            }

            const odometer = appData.general.items.find(item => item.key === 'odometer');
            if (odometer) {
                document.getElementById('odometer-reading').textContent = `${parseInt(odometer.value).toLocaleString()} ${odometer.unit}`;
            }
        }
        
        function renderCharts() {
            // Destroy existing charts to prevent memory leaks and conflicts
            for (const chartId in myCharts) {
                if (myCharts[chartId]) {
                    myCharts[chartId].destroy();
                }
            }
            myCharts = {}; 

            const fuelLevel = appData.exterior.items.find(item => item.key === 'fuelLevel')?.value;
            const waterLevel = appData.pump.items.find(item => item.key === 'waterTankLevel')?.value;

            const levelToPercent = { 'Full': 100, '3/4': 75, '1/2': 50, '1/4': 25, 'Less than 1/4': 10 };
            
            const fuelPercent = levelToPercent[fuelLevel] || 0;
            const waterPercent = levelToPercent[waterLevel] || 0;

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            };

            const fuelCtx = document.getElementById('fuelChart');
            const waterCtx = document.getElementById('waterChart');

            if (fuelCtx) {
                 myCharts.fuelChart = new Chart(fuelCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Fuel', 'Empty'],
                        datasets: [{
                            data: [fuelPercent, 100 - fuelPercent],
                            backgroundColor: ['#1e293b', '#e2e8f0'],
                            borderColor: '#ffffff',
                            borderWidth: 2,
                        }]
                    },
                    options: chartOptions,
                    plugins: [{
                        id: 'centerText',
                        beforeDraw: function(chart) {
                            const ctx = chart.ctx;
                            const R = chart.chartArea.right;
                            const L = chart.chartArea.left;
                            const B = chart.chartArea.bottom;
                            const T = chart.chartArea.top;
                            const width = R-L, height = B-T;
                            ctx.restore();
                            const fontSize = (height / 114).toFixed(2);
                            ctx.font = `bold ${fontSize*1.5}rem Inter`;
                            ctx.textBaseline = 'middle';
                            const text = `${fuelPercent}%`;
                            const textX = Math.round((width - ctx.measureText(text).width) / 2) + L;
                            const textY = T + (height / 2);
                            ctx.fillText(text, textX, textY);
                            ctx.save();
                        }
                    }]
                });
            }

            if (waterCtx) {
                myCharts.waterChart = new Chart(waterCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Water', 'Empty'],
                        datasets: [{
                            data: [waterPercent, 100 - waterPercent],
                            backgroundColor: ['#3b82f6', '#e2e8f0'],
                            borderColor: '#ffffff',
                            borderWidth: 2,
                        }]
                    },
                    options: chartOptions,
                    plugins: [{
                        id: 'centerText',
                        beforeDraw: function(chart) {
                            const ctx = chart.ctx;
                            const R = chart.chartArea.right;
                            const L = chart.chartArea.left;
                            const B = chart.chartArea.bottom;
                            const T = chart.chartArea.top;
                            const width = R-L, height = B-T;
                            ctx.restore();
                            const fontSize = (height / 114).toFixed(2);
                            ctx.font = `bold ${fontSize*1.5}rem Inter`;
                            ctx.textBaseline = 'middle';
                            const text = `${waterPercent}%`;
                            const textX = Math.round((width - ctx.measureText(text).width) / 2) + L;
                            const textY = T + (height / 2);
                            ctx.fillText(text, textX, textY);
                            ctx.save();
                        }
                    }]
                });
            }
        }

        function renderSection(sectionKey) {
            const section = appData[sectionKey];
            if (!section) return;

            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.section === sectionKey);
            });

            const checklistContainer = document.getElementById('checklist');
            const sectionTitle = document.getElementById('section-title');
            const sectionIntro = document.getElementById('section-intro');
            
            sectionTitle.textContent = section.title;
            sectionIntro.textContent = section.intro;
            checklistContainer.innerHTML = '';

            if (section.items.length === 0 && sectionKey === 'deficiencies') {
                checklistContainer.innerHTML = `<li class="text-slate-500">No deficiencies found.</li>`;
                return;
            } else if (section.items.length === 0) {
                 checklistContainer.innerHTML = `<li class="text-slate-500">No items to display in this section.</li>`;
                 return;
            }

            section.items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'p-4 rounded-lg flex flex-col sm:flex-row sm:items-center sm:justify-between';
                
                const statusClass = statusMap[item.status] || 'bg-slate-100 text-slate-800';
                li.classList.add(statusClass.split(' ')[0]);

                let itemLabel = item.label;
                if(sectionKey === 'deficiencies' && item.section){
                    itemLabel = `${item.section}: ${item.label}`;
                }

                let valueDisplay = item.value;
                let statusDisplay = item.status;
                let noteDisplay = item.note || '';

                if (isEditMode && sectionKey !== 'deficiencies') {
                    let valueInputHtml = '';
                    if (item.type === 'text' || item.type === 'date') {
                        valueInputHtml = `<input type="${item.type}" id="edit-value-${item.key}" class="edit-input flex-grow mr-2" value="${item.value}">`;
                    } else if (item.type === 'number') {
                        valueInputHtml = `<input type="number" id="edit-value-${item.key}" class="edit-input flex-grow mr-2" value="${item.value}"> ${item.unit || ''}`;
                    } else if (item.type === 'select' && item.options) {
                        valueInputHtml = `<select id="edit-value-${item.key}" class="edit-select flex-grow mr-2">`;
                        item.options.forEach(option => {
                            valueInputHtml += `<option value="${option}" ${item.value === option ? 'selected' : ''}>${option}</option>`;
                        });
                        valueInputHtml += `</select>`;
                    }

                    const statusSelectHtml = `
                        <select id="edit-status-${item.key}" class="edit-select w-28 mr-2">
                            <option value="OK" ${item.status === 'OK' ? 'selected' : ''}>OK</option>
                            <option value="Issue" ${item.status === 'Issue' ? 'selected' : ''}>Issue</option>
                            <option value="Danger" ${item.status === 'Danger' ? 'selected' : ''}>Danger</option>
                        </select>
                    `;
                    
                    const noteInputHtml = `
                        <textarea id="edit-note-${item.key}" class="edit-input mt-2 w-full text-xs" placeholder="Add note...">${noteDisplay}</textarea>
                    `;

                    li.innerHTML = `
                        <div class="flex-grow w-full">
                            <label for="edit-value-${item.key}" class="font-semibold block text-sm mb-1">${itemLabel}</label>
                            <div class="flex items-center flex-wrap">
                                <div class="flex-grow min-w-[150px]">${valueInputHtml}</div>
                                <div class="w-full sm:w-auto mt-2 sm:mt-0">${statusSelectHtml}</div>
                            </div>
                            ${noteInputHtml}
                        </div>
                    `;
                } else {
                     li.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold">${itemLabel}</p>
                            ${item.note ? `<p class="mt-1 sm:mt-0 sm:ml-4 text-xs italic text-slate-600">${item.note}</p>` : ''}
                        </div>
                        <div class="mt-2 sm:mt-0 sm:ml-4 font-medium px-3 py-1 rounded-full text-sm ${statusClass} whitespace-nowrap">
                            ${valueDisplay}
                        </div>
                    `;
                }
                checklistContainer.appendChild(li);
            });
        }

        function generateFormLink() {
            let formParams = [];
            
            // General Info
            appData.general.items.forEach(item => {
                if (fieldMappings[item.key]) {
                    formParams.push(`${fieldMappings[item.key]}=${encodeURIComponent(item.value)}`);
                }
            });

            // Other Sections (Value and Status, and Notes)
            for (const sectionKey in appData) {
                if (sectionKey !== 'general' && sectionKey !== 'deficiencies' && appData[sectionKey].items) {
                    appData[sectionKey].items.forEach(item => {
                        if (fieldMappings[item.key]) {
                            // Map the item's value
                            formParams.push(`${fieldMappings[item.key]}=${encodeURIComponent(item.value)}`);
                            
                            // Map the item's status (you might need a separate field for this in Google Forms)
                            // For simplicity, we'll append status to the value or create a separate entry if you have one
                            // Example: If you have a separate entry for status, uncomment and configure:
                            // if (fieldMappings[`${item.key}Status`]) { 
                            //     formParams.push(`${fieldMappings[`${item.key}Status`]}=${encodeURIComponent(item.status)}`);
                            // }

                            // Map the item's note (if it exists and a mapping is provided)
                            if (item.note && fieldMappings[`${item.key}Note`]) { 
                                formParams.push(`${fieldMappings[`${item.key}Note`]}=${encodeURIComponent(item.note)}`);
                            }
                        }
                    });
                }
            }

            // Aggregate all deficiencies into one field if a mapping is provided
            if (fieldMappings['deficienciesSummary']) {
                const allDeficiencies = appData.deficiencies.items.map(def => `${def.section}: ${def.label} (${def.value}) - ${def.note || 'No specific note.'}`).join('\n');
                formParams.push(`${fieldMappings['deficienciesSummary']}=${encodeURIComponent(allDeficiencies)}`);
            }

            const formLink = `${FORM_ACTION_URL}/prefill?${formParams.join('&')}`;
            window.open(formLink, '_blank');
        }
    </script>
</body>
</html>
