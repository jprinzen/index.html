<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fire Truck Monthly Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        spin: {
                          '0%': { transform: 'rotate(0deg)' },
                          '100%': { transform: 'rotate(360deg)' },
                        }
                    },
                    animation: {
                        spin: 'spin 1s linear infinite',
                    }
                },
            },
        }
    </script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        body { background-color: #f0f2f5; }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .btn { @apply inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background; }
        .btn-primary { @apply bg-red-600 text-white hover:bg-red-700; }
        .btn-secondary { @apply bg-gray-200 text-gray-800 hover:bg-gray-300; }
        .card { @apply bg-white rounded-xl shadow-md overflow-hidden; }
        .loader { @apply w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app" v-cloak class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto">

        <!-- Header -->
        <header class="mb-8">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600 mr-3"><path d="M14 16.5V8.28a2.23 2.23 0 0 0-1.76-2.18l-5.34-1.28a2.24 2.24 0 0 0-2.52 2.18v8.68a2.24 2.24 0 0 0 2.52 2.18l5.34-1.28A2.23 2.23 0 0 0 14 16.5Z"/><path d="m14 8 3-3 3 3"/><path d="M17 5v3.5a2.5 2.5 0 0 1-5 0V5"/><path d="M2 14h10"/><path d="M6 11h2"/><path d="M10 11h2"/></svg>
                        Fire Truck Checklist
                    </h1>
                    <p class="text-gray-500 mt-1">A shared, AI-powered checklist for your department.</p>
                </div>
                <div>
                    <button @click="showCustomizeModal = true" class="btn btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                        Customize Checklist
                    </button>
                </div>
            </div>
             <div class="text-xs text-gray-400 mt-2">Your User ID: <span class="font-mono">{{ userId }}</span></div>
        </header>

        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Trucks List -->
            <div class="lg:col-span-1">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Department Trucks</h2>
                <div class="space-y-4">
                    <div v-if="trucks.length === 0" class="text-center py-10 px-4 bg-white rounded-lg shadow-sm">
                        <p class="text-gray-500">No trucks added yet.</p>
                        <p class="text-sm text-gray-400">Add the first truck to get started.</p>
                    </div>
                    <div v-for="truck in trucks" :key="truck.id" class="card flex items-center p-4 justify-between">
                         <div>
                            <h3 class="font-bold text-lg">{{ truck.name }}</h3>
                            <p class="text-sm text-gray-500">{{ truck.identifier }}</p>
                        </div>
                        <button @click="startCheck(truck)" class="btn btn-primary px-4 py-2">Start Check</button>
                    </div>
                    <button @click="showAddTruckModal = true" class="w-full btn btn-secondary py-3 border-2 border-dashed hover:bg-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        Add New Truck
                    </button>
                </div>
            </div>

            <!-- Recent Checks -->
            <div class="lg:col-span-2">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Recent Checks</h2>
                 <div class="card p-6">
                    <div v-if="checks.length === 0" class="text-center py-10">
                         <p class="text-gray-500">No checks completed yet.</p>
                         <p class="text-sm text-gray-400">Completed checks will appear here.</p>
                    </div>
                    <div v-else class="space-y-4">
                        <div v-for="check in recentChecks" :key="check.id" class="p-4 rounded-lg border flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div class="mb-2 sm:mb-0">
                                <p class="font-semibold">{{ check.truckName }}</p>
                                <p class="text-sm text-gray-500">Checked on {{ check.date ? new Date(check.date.seconds * 1000).toLocaleDateString() : 'Date N/A' }}</p>
                                <p class="text-xs text-gray-400 mt-1">By: <span class="font-mono">{{ check.completedBy }}</span></p>
                            </div>
                            <div class="text-right">
                                <span :class="getCheckStatusClass(check)" class="px-2 py-1 text-xs font-semibold rounded-full">
                                    {{ getCheckStatus(check) }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modals -->
        <div v-if="showAddTruckModal" @click.self="showAddTruckModal = false" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal-content">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Add a New Truck</h3>
                <form @submit.prevent="addTruck">
                    <div class="space-y-4">
                        <div>
                            <label for="truckName" class="block text-sm font-medium text-gray-700">Truck Name</label>
                            <input type="text" v-model="newTruck.name" id="truckName" placeholder="e.g., Engine 1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label for="truckIdentifier" class="block text-sm font-medium text-gray-700">Identifier</label>
                            <input type="text" v-model="newTruck.identifier" id="truckIdentifier" placeholder="e.g., E-123" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" @click="showAddTruckModal = false" class="btn btn-secondary px-4 py-2">Cancel</button>
                        <button type="submit" class="btn btn-primary px-4 py-2">Add Truck</button>
                    </div>
                </form>
            </div>
        </div>

        <div v-if="showCustomizeModal" @click.self="showCustomizeModal = false" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl modal-content h-full max-h-[90vh] flex flex-col">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-2">Customize Shared Checklist</h3>
                
                <div class="p-4 mb-4 bg-red-50 border border-red-200 rounded-lg">
                    <label for="suggestionQuery" class="block text-sm font-medium text-gray-700 mb-1">Get a head start with AI:</label>
                    <div class="flex gap-2">
                        <input type="text" id="suggestionQuery" v-model="checklistSuggestionQuery" placeholder="e.g., Ladder Truck, Ambulance" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                        <button @click="generateChecklistItems" :disabled="isGeneratingItems" class="btn btn-primary px-3">
                            <span v-if="!isGeneratingItems" class="flex items-center">✨ Suggest Items</span>
                            <span v-else class="flex items-center"><div class="loader mr-2"></div> Working...</span>
                        </button>
                    </div>
                </div>

                <h4 class="text-md font-semibold text-gray-800 mb-2">Current Items</h4>
                <div class="flex-grow overflow-y-auto pr-2 border-t pt-2">
                     <div v-for="(group, category) in groupedChecklistItems" :key="category" class="mb-4">
                        <h5 class="font-semibold text-gray-700 border-b pb-1 mb-2">{{ category }}</h5>
                        <ul class="space-y-2">
                           <li v-for="item in group" :key="item.id" class="flex justify-between items-center bg-gray-50 p-2 rounded-md">
                               <span>{{ item.name }}</span>
                               <button @click="removeChecklistItem(item.id)" class="text-red-500 hover:text-red-700">
                                   <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                               </button>
                           </li>
                        </ul>
                    </div>
                </div>
                <form @submit.prevent="addChecklistItem" class="mt-4 border-t pt-4">
                    <h4 class="text-md font-semibold text-gray-800 mb-2">Add New Item Manually</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                         <input type="text" v-model="newChecklistItem.name" placeholder="New Item Name" class="sm:col-span-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm" required>
                         <input type="text" v-model="newChecklistItem.category" placeholder="Category" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm" required>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                         <button type="submit" class="btn btn-primary px-4 py-2">Add Item</button>
                         <button type="button" @click="showCustomizeModal = false" class="btn btn-secondary px-4 py-2">Close</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div v-if="currentCheck.truck" @click.self="cancelCheck" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl modal-content h-full max-h-[90vh] flex flex-col">
                <h3 class="text-xl font-bold leading-6 text-gray-900 mb-4">Monthly Check: {{ currentCheck.truck.name }}</h3>
                <div class="flex-grow overflow-y-auto pr-4">
                    <form id="checkForm" @submit.prevent="submitCheck">
                        <div v-for="(group, category) in groupedChecklistItems" :key="category" class="mb-6">
                            <h4 class="font-semibold text-lg text-gray-800 border-b-2 border-red-200 pb-2 mb-3">{{ category }}</h4>
                            <div class="space-y-4">
                                <div v-for="item in group" :key="item.id" class="p-3 bg-gray-50 rounded-lg">
                                    <label class="block font-medium text-gray-700 mb-2">{{ item.name }}</label>
                                    <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                                        <div class="flex items-center space-x-4">
                                            <label class="flex items-center">
                                                <input type="radio" :name="'status-' + item.id" value="OK" v-model="currentCheck.items[item.id].status" class="form-radio h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                                <span class="ml-2 text-green-700">OK</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" :name="'status-' + item.id" value="Needs Attention" v-model="currentCheck.items[item.id].status" class="form-radio h-4 w-4 text-yellow-600 border-gray-300 focus:ring-yellow-500">
                                                <span class="ml-2 text-yellow-700">Needs Attention</span>
                                            </label>
                                        </div>
                                        <div class="flex-grow flex items-center gap-2">
                                            <input type="text" placeholder="Notes (optional)" v-model="currentCheck.items[item.id].notes" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                                            <button v-if="currentCheck.items[item.id].status === 'Needs Attention'" type="button" @click="expandNote(item.id)" :disabled="isGeneratingNote === item.id" class="btn btn-secondary p-2">
                                                <span v-if="isGeneratingNote !== item.id">✨</span>
                                                <div v-else class="loader"></div>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="mt-6 flex justify-end space-x-3 border-t pt-4">
                     <button type="button" @click="cancelCheck" class="btn btn-secondary px-4 py-2">Cancel</button>
                     <button type="submit" form="checkForm" class="btn btn-primary px-4 py-2">Submit Check</button>
                </div>
            </div>
        </div>
        
        <div v-if="messageModal.show" @click.self="closeMessage" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 modal">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm modal-content text-center">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">{{ messageModal.title }}</h3>
                <p class="text-sm text-gray-600 mb-6 whitespace-pre-wrap">{{ messageModal.body }}</p>
                <button @click="closeMessage" class="btn btn-primary px-4 py-2">OK</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-truck-check-app';

        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);
        const auth = getAuth(fbApp);
        
        createApp({
            data() {
                return {
                    isAuthReady: false,
                    userId: null,
                    trucks: [],
                    checks: [],
                    checklistItems: [],
                    showAddTruckModal: false,
                    showCustomizeModal: false,
                    newTruck: { name: '', identifier: '' },
                    newChecklistItem: { name: '', category: '' },
                    currentCheck: {
                        truck: null,
                        items: {}
                    },
                    isGeneratingItems: false,
                    isGeneratingNote: null, // will hold item ID
                    checklistSuggestionQuery: '',
                    messageModal: { show: false, title: '', body: '' },
                }
            },
            computed: {
                groupedChecklistItems() {
                    return this.checklistItems.reduce((acc, item) => {
                        const category = item.category || 'General';
                        if (!acc[category]) {
                            acc[category] = [];
                        }
                        acc[category].push(item);
                        return acc;
                    }, {});
                },
                recentChecks() {
                   return [...this.checks].sort((a,b) => (b.date?.seconds ?? 0) - (a.date?.seconds ?? 0));
                }
            },
            methods: {
                // --- Authentication ---
                async setupFirebase() {
                    await setPersistence(auth, browserLocalPersistence);
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            this.userId = user.uid;
                        } else {
                           try {
                                const userCredential = await signInAnonymously(auth);
                                this.userId = userCredential.user.uid;
                            } catch (error) {
                                console.error("Anonymous sign-in failed:", error);
                            }
                        }
                        if(this.userId) {
                            this.isAuthReady = true;
                            this.loadInitialData();
                        }
                    });
                },
                
                // --- Data Loading ---
                async loadInitialData() {
                    if (!this.isAuthReady) return;
                    const publicDataPath = `artifacts/${appId}/public/data`;
                    this.unsubscribeTrucks = onSnapshot(collection(db, `${publicDataPath}/trucks`), (snapshot) => {
                        this.trucks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });

                    this.unsubscribeChecks = onSnapshot(collection(db, `${publicDataPath}/checks`), (snapshot) => {
                        this.checks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                    
                    this.loadChecklistTemplate();
                },
                async loadChecklistTemplate() {
                    const templateRef = doc(db, `artifacts/${appId}/public/data/checklist_template/default`);
                    this.unsubscribeTemplate = onSnapshot(templateRef, async (docSnap) => {
                        if (docSnap.exists()) {
                            this.checklistItems = docSnap.data().items || [];
                        } else {
                            const defaultItems = [
                                { id: crypto.randomUUID(), name: 'Engine Oil Level', category: 'Engine Compartment' },
                                { id: crypto.randomUUID(), name: 'Coolant Level', category: 'Engine Compartment' },
                                { id: crypto.randomUUID(), name: 'Tire Pressure & Condition', category: 'Exterior' },
                                { id: crypto.randomUUID(), name: 'Headlights & Taillights', category: 'Exterior' },
                                { id: crypto.randomUUID(), name: 'Sirens & Horns', category: 'Cab' },
                                { id: crypto.randomUUID(), name: 'Radio Communication', category: 'Cab' },
                            ];
                            await setDoc(templateRef, { items: defaultItems });
                            this.checklistItems = defaultItems;
                        }
                    });
                },

                // --- Trucks & Checks ---
                async addTruck() {
                    if (this.newTruck.name.trim() === '') return;
                    const publicDataPath = `artifacts/${appId}/public/data`;
                    await addDoc(collection(db, `${publicDataPath}/trucks`), { ...this.newTruck });
                    this.newTruck = { name: '', identifier: '' };
                    this.showAddTruckModal = false;
                },
                startCheck(truck) {
                    this.currentCheck.truck = truck;
                    const items = {};
                    this.checklistItems.forEach(item => {
                        items[item.id] = {
                            name: item.name,
                            category: item.category,
                            status: 'OK',
                            notes: ''
                        };
                    });
                    this.currentCheck.items = items;
                },
                cancelCheck() {
                    this.currentCheck = { truck: null, items: {} };
                },
                async submitCheck() {
                    const checkData = {
                        truckId: this.currentCheck.truck.id,
                        truckName: this.currentCheck.truck.name,
                        date: serverTimestamp(),
                        completedBy: this.userId,
                        items: Object.values(this.currentCheck.items)
                    };
                    const publicDataPath = `artifacts/${appId}/public/data`;
                    await addDoc(collection(db, `${publicDataPath}/checks`), checkData);
                    this.cancelCheck();
                },
                
                // --- Checklist Customization ---
                async addChecklistItem(item = null) {
                    const itemToAdd = item ? item : this.newChecklistItem;
                    if (itemToAdd.name.trim() === '' || itemToAdd.category.trim() === '') return;
                    const newItem = {
                        id: crypto.randomUUID(),
                        name: itemToAdd.name,
                        category: itemToAdd.category
                    };
                    const updatedItems = [...this.checklistItems, newItem];
                    const templateRef = doc(db, `artifacts/${appId}/public/data/checklist_template/default`);
                    await setDoc(templateRef, { items: updatedItems });
                    this.newChecklistItem = { name: '', category: '' };
                },
                 async addChecklistItemsBatch(items) {
                    const newItems = items.map(item => ({
                        id: crypto.randomUUID(),
                        name: item.name,
                        category: item.category
                    }));
                    const updatedItems = [...this.checklistItems, ...newItems];
                    const templateRef = doc(db, `artifacts/${appId}/public/data/checklist_template/default`);
                    await setDoc(templateRef, { items: updatedItems });
                },
                async removeChecklistItem(itemId) {
                     if (!confirm('Are you sure you want to remove this shared item? This will affect all users.')) return;
                     const updatedItems = this.checklistItems.filter(item => item.id !== itemId);
                     const templateRef = doc(db, `artifacts/${appId}/public/data/checklist_template/default`);
                     await setDoc(templateRef, { items: updatedItems });
                },

                // --- Gemini API Methods ---
                async generateChecklistItems() {
                    if (!this.checklistSuggestionQuery.trim() || this.isGeneratingItems) return;
                    this.isGeneratingItems = true;

                    const prompt = `Generate a JSON array of checklist items for a fire apparatus. The apparatus type is: "${this.checklistSuggestionQuery}". Each object in the array should have two properties: "name" (the checklist item, e.g., "Check SCBA cylinder pressure") and "category" (e.g., "Safety Equipment", "Cab Interior", "Pump Operations"). Provide a comprehensive list appropriate for a monthly check.`;

                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING" },
                                        category: { type: "STRING" }
                                    },
                                    required: ["name", "category"]
                                }
                            }
                        }
                    };
                    
                    try {
                        const apiKey = "";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                        
                        const result = await response.json();
                        const generatedText = result.candidates[0].content.parts[0].text;
                        const items = JSON.parse(generatedText);

                        if (items && items.length > 0) {
                            await this.addChecklistItemsBatch(items);
                            this.showMessage('Success', `Added ${items.length} suggested items to the checklist.`);
                        } else {
                           this.showMessage('No Items Generated', 'The AI did not return any items. Please try a different query.');
                        }
                    } catch (error) {
                        console.error("Error generating checklist items:", error);
                        this.showMessage('AI Error', 'Could not generate checklist items. Please check the console for details.');
                    } finally {
                        this.isGeneratingItems = false;
                        this.checklistSuggestionQuery = '';
                    }
                },

                async expandNote(itemId) {
                    const noteText = this.currentCheck.items[itemId].notes;
                    if (!noteText.trim() || this.isGeneratingNote) return;
                    this.isGeneratingNote = itemId;

                    const prompt = `Expand the following brief maintenance note for a fire truck into a professional, detailed log entry. The original note is: "${noteText}". The expanded note should clearly state the issue and suggest an action.`;
                    
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                    try {
                        const apiKey = "";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                        
                        const result = await response.json();
                        const expandedText = result.candidates[0].content.parts[0].text;
                        this.currentCheck.items[itemId].notes = expandedText.trim();

                    } catch (error) {
                        console.error("Error expanding note:", error);
                        this.showMessage('AI Error', 'Could not expand the note. Please check the console for details.');
                    } finally {
                        this.isGeneratingNote = null;
                    }
                },
                
                // --- UI Helpers ---
                getCheckStatus(check) {
                    if (!check.items) return 'Data Error';
                    const hasIssues = check.items.some(item => item.status === 'Needs Attention');
                    return hasIssues ? 'Needs Attention' : 'All Clear';
                },
                getCheckStatusClass(check) {
                     if (!check.items) return 'bg-gray-100 text-gray-800';
                     const hasIssues = check.items.some(item => item.status === 'Needs Attention');
                     return hasIssues ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
                },
                showMessage(title, body) {
                    this.messageModal.title = title;
                    this.messageModal.body = body;
                    this.messageModal.show = true;
                },
                closeMessage() {
                    this.messageModal.show = false;
                }
            },
            mounted() {
                this.setupFirebase();
            },
            beforeUnmount() {
                if (this.unsubscribeTrucks) this.unsubscribeTrucks();
                if (this.unsubscribeChecks) this.unsubscribeChecks();
                if (this.unsubscribeTemplate) this.unsubscribeTemplate();
            }
        }).mount('#app');

    </script>
</body>
</html>
